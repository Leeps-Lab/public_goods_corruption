{{ extends "../_templates/global/Page.html" }}

{{ block content }}

    <div class="container" style="padding-bottom: 20px;">
        <!-- Header Row -->
        <div class="row px-5 pb-5 pt-0">
            <div class="col-4 text-center"><b>Segmento:</b> {{ segment }}</div>
            <div class="col-4 text-center"><b>Ronda:</b> {{ player.round_number }}</div>
            <div class="col-4 text-center"><b>Rol:</b> {{ player.role }}</div>
        </div>

        <!-- Main Content -->
        <div class="row main-content-row">
            <!-- Left Column: Role Info -->
            <div class="
                {% if not private_interaction %}
                    col-12
                {% elif chat_only_officer and not officer_interactions_public and player.id_in_group != 4 %}
                    col-5
                {% else %}
                    col-3
                {% endif %}
                d-flex flex-column align-items-center justify-content-center p-5 text-center"
                style="{% if private_interaction %}border-right: solid #808080;{% endif %}">
                {{ if player.id_in_group == 4 }}
                    <p>Tu rol es el de <b>funcionario</b>.</p>
                    <p>El multiplicador es <b>{{ group.multiplier }}</b></p>
                    <p>Tienes <b><span id="points-value">{{ player.current_points }}</span> puntos</b>.</p>
                {{ else }}
                    <p>Tu rol es el de <b>ciudadano {{ player.id_in_group }}</b>.</p>
                    <div id="beforeContribution">
                        <p id="points-info">
                            Tienes <b><span id="points-value">{{ player.current_points }}</span> puntos</b> para distribuir entre tu cuenta y el proyecto común.
                        </p>
                        <p>
                            Puntos a contribuir al proyecto común:
                        </p>
                        <div class="d-flex">
                            <input 
                                id="id_contribution_points" 
                                type="number" 
                                name="contribution_points" 
                                class="form-control" 
                                style="flex: 1;">
                            <button 
                                id="send_to_b_button" 
                                type="button" 
                                class="btn btn-primary" 
                                onclick="sendContribution()">
                                Enviar puntos
                            </button>
                        </div>
                        {{ formfield_errors 'contribution_points' }}
                    </div>
                    <!-- Display message after contribution -->
                    <div id="afterContribution" style="display: none;">
                    </div>
                {{ endif }}
            </div>

            <!-- Right Column: Interaction Interface -->
            {{ if private_interaction }}
                <div class="
                    {% if chat_only_officer and not officer_interactions_public and player.id_in_group != 4 %}
                        col-7 
                    {% else %}
                        col-9
                    {% endif %}
                    right-column">
                    <!-- Chats and send/request buttons -->
                    {{ if chat_only_officer and player.id_in_group != 4}}
                        <div class="chat-container row p-5">
                            <!-- Show only the first chat from others (Officer) -->
                            <div class="col" style="max-width: 400px;">
                                <div class="row" style="margin-bottom: 30px;">
                                    <p class="text-center">Chat con {{ others.0.role }}</p>
                                    {{ chat nickname=player.role channel=others.0.channel }}
                                </div>
                                <!-- Buttons (Only for the officer chat) -->
                                <div class="row">
                                    <p class="text-center">Interacción con {{ others.0.role }}</p>
                                    <div class="d-flex align-items-center spacing-between" style="gap: 10px; justify-content: center;">
                                        <button 
                                            type="button" 
                                            id="id_offerButton_{{ others.0.id_in_group }}" 
                                            class="btn btn-outline-primary" 
                                            onclick="initiatingTransaction('Ofrece', {{ player.id_in_group }}, {{ others.0.id_in_group }}, 'id_offerInput')">
                                            Ofrecer puntos:
                                        </button>
                                        <input 
                                            type="number" 
                                            id="id_offerInput_{{ others.0.id_in_group }}" 
                                            class="form-control" 
                                            style="width: 30%;">
                                    </div>
                                    <div class="d-flex align-items-center" style="gap: 10px; justify-content: center;">
                                        <button 
                                            type="button"
                                            id="id_requestButton_{{ others.0.id_in_group }}"
                                            class="btn btn-outline-success"
                                            onclick="initiatingTransaction('Solicita', {{ player.id_in_group }}, {{ others.0.id_in_group }}, 'id_requestInput')">
                                            Solicitar puntos:
                                        </button>
                                        <input 
                                            type="text"
                                            id="id_requestInput_{{ others.0.id_in_group }}"
                                            class="form-control" 
                                            style="width: 30%;">
                                    </div>
                                    <!-- Action messages -->
                                    <div class="row" id="id_afterAction_{{ others.0.id_in_group }}" style="display: none; margin-top: 30px;">
                                    </div>
                                </div>
                            </div>

                            <!-- Additional chats in the same row -->
                            {{ for extra_chat in additional_channels }}
                                <div class="col">
                                    <div class="row" style="margin-bottom: 30px;">
                                        <p class="text-center">{{ extra_chat.role }}</p>
                                        {{ chat nickname=player.role channel=extra_chat.channel }}
                                    </div>
                                </div>
                            {{ endfor }}
                        </div>
                    
                    <!-- Participants chat wiht everyone -->
                    {{ else }}
                        <div class="chat-container row p-5">
                            {{ for other in others }}
                                <div class="col">
                                    <!-- Chat -->
                                    <div class="row" style="margin-bottom: 30px;">
                                        <p class="text-center">Chat con {{ other.role }}</p>
                                        {{ chat nickname=player.role channel=other.channel }}
                                    </div>
                                    <!-- Buttons -->
                                    <div class="row">
                                        <p class="text-center">Interacción con {{ other.role }}</p>
                                        <!-- Offer section -->
                                        <div class="d-flex align-items-center spacing-between" style="gap: 10px; justify-content: center;">
                                            <button 
                                                type="button" 
                                                id="id_offerButton_{{ other.id_in_group }}" 
                                                class="btn btn-outline-primary" 
                                                onclick="initiatingTransaction('Ofrece', {{ player.id_in_group }}, {{ other.id_in_group }}, 'id_offerInput')">
                                                Ofrecer puntos:
                                            </button>
                                            <input 
                                                type="number" 
                                                id="id_offerInput_{{ other.id_in_group }}" 
                                                class="form-control" 
                                                style="width: 30%;">
                                        </div>
                                        <!-- Request section -->
                                        <div class="d-flex align-items-center" style="gap: 10px; justify-content: center;">
                                            <button 
                                                type="button"
                                                id="id_requestButton_{{ other.id_in_group }}"
                                                class="btn btn-outline-success"
                                                onclick="initiatingTransaction('Solicita', {{ player.id_in_group }}, {{ other.id_in_group }}, 'id_requestInput')">
                                                Solicitar puntos:
                                            </button>
                                            <input 
                                                type="text"
                                                id="id_requestInput_{{ other.id_in_group }}"
                                                class="form-control"
                                                style="width: 30%;">
                                        </div>
                                    </div>
                                    <!-- Action messages -->
                                    <div class="row" id="id_afterAction_{{ other.id_in_group }}" style="display: none; margin-top: 30px;">
                                    </div>
                                </div>
                            {{ endfor }}
                        </div>

                        <!-- Additional chats below -->
                        {{ if officer_interactions_public and player.id_in_group != 4 }}
                            <div class="chat-container row p-5">
                                {{ for extra_chat in additional_channels }}
                                    <div class="col">
                                        <!-- Additional Chat -->
                                        <div class="row" style="margin-bottom: 30px;">
                                            <p class="text-center">{{ extra_chat.role }}</p>
                                            {{ chat nickname=player.role channel=extra_chat.channel }}
                                        </div>
                                    </div>
                                {{ endfor }}
                            </div>
                        {{ endif }}

                    {{ endif}}

                    <!-- Transactions and balance -->
                    <div class="row p-5">
                        <h5 class="text-center">Balance de transacciones</h5>
                        <div id="transactionsContainer">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Jugador</th>
                                        <th>Acción</th>
                                        <th>A</th>
                                        <th>Puntos</th>
                                        <th>¿Se aceptó?</th>
                                        <th>Balance</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {{ endif }}
        </div>
        <br>

        <!-- History Section -->
        <h4 class="text-center">Historia</h4>
        <br>
        {{ include '../_templates/global/history.html' }}     
        
        <!-- Include block and general instructions -->
        {{ include_sibling 'instructions_buttons.html' }}
    </div>
    
    {{ if player.id_in_group == 4}}
        <br>{{ next_button }}
    {{ else }}
        <button id="next_button" type="button" class="btn btn-primary" onclick="verifyContribution()">Siguiente</button>
    {{ endif }}

    <script>
        let sequentialDecisionFlag = js_vars.secuential_decision; // Sequential decision flag
        const ID_PREFIXES = {
            offerButton: 'id_offerButton_',
            offerInput: 'id_offerInput_',
            requestButton: 'id_requestButton_',
            requestInput: 'id_requestInput_',
            afterAction: 'id_afterAction_'
        };

        function sendContribution() {
            let contributionPoints = parseFloat(document.getElementById('id_contribution_points').value);
            liveSend({'type': 'contributionPoints', 'value': contributionPoints});
        }

        function verifyContribution() {
            const beforeContribution = document.getElementById("beforeContribution");
            const afterContribution = document.getElementById("afterContribution");

            // Check if contribution was already sent
            if (beforeContribution.style.display === "none" && afterContribution.style.display === "block") {
                document.getElementById("form").submit();
            } else {
                alert("Debes enviar tu contribución antes de continuar.");
            }
        }

        function initiatingTransaction(action, playerId, otherId, inputPrefix) {
            /**
             * Handles initiating a new transaction (offer or request points).
             * @param {string} action - The action to perform ('Ofrece' or 'Solicita').
             * @param {number} playerId - The ID of the player initiating the transaction.
             * @param {number} otherId - The ID of the player receiving the transaction.
             * @param {string} inputPrefix - The prefix for the input ID.
             */
            const inputId = `${inputPrefix}_${otherId}`;
            const inputElement = document.getElementById(inputId);
            const inputValue = parseFloat(inputElement.value);

            if (!Number.isInteger(inputValue) || isNaN(inputValue)) {
                alert("Por favor, ingresa una cantidad válida.");
            } else if (inputValue < 0) {
                alert("No puedes ingresar una cantidad negativa.");
            } else {
                liveSend({
                    'type': 'initiatingTransaction',
                    'action': action,
                    'value': inputValue,
                    'initiatorId': playerId,
                    'receiverId': otherId
                });
            }
        }

        function closingTransaction(status, myId, otherId, transactionId) {
            /**
             * Handles post-transaction actions such as accept, decline, or cancel.
             * @param {string} status - The status update of the transaction ('Aceptado', 'Rechazado', 'Cancelado').
             * @param {number} myId - The ID of the current player.
             * @param {number} otherId - The ID of the other player involved in the transaction.
             * @param {number} transactionId - The transaction ID.
             */
            console.log(`Status: ${status}, My ID: ${myId}, Other ID: ${otherId}, Transaction ID: ${transactionId}`);

            liveSend({
                'type': 'closingTransaction',
                'status': status,
                'initiatorId': (status === 'Cancelado') ? myId : otherId,
                'receiverId': (status === 'Cancelado') ? otherId : myId,
                'transactionId': transactionId
            });
        }

        if (sequentialDecisionFlag) {
            disableLeftEnableRight();
        }
        
        // Functions for sequential decision
        function disableLeftEnableRight() {
            document.querySelectorAll(".col-3 input, .col-3 button").forEach(el => el.disabled = true); // Disable inputs and buttons in the left column
            document.querySelectorAll(".right-column input, .right-column button").forEach(el => el.disabled = false); // Enable inputs and buttons in the right column
        }

        function enableLeftDisableRight() {
            document.querySelectorAll(".col-3 input, .col-3 button").forEach(el => el.disabled = false); // Enable inputs and buttons in the left column
            document.querySelectorAll(".right-column input, .right-column button").forEach(el => el.disabled = true); // Disable inputs and buttons in the right column
        }

        // Parse the remaining time from the timer element
        function getRemainingTime() {
            const timerElement = document.querySelector('.otree-timer__time-left');
            if (timerElement) {
                const textContent = timerElement.textContent.trim(); // Trim whitespace
                if (textContent) {
                    const timeParts = textContent.split(':');
                    if (timeParts.length === 2) { // Ensure the content has exactly two parts
                        const minutes = parseInt(timeParts[0], 10);
                        const seconds = parseInt(timeParts[1], 10);
                        if (!isNaN(minutes) && !isNaN(seconds)) {
                            const totalSeconds = minutes * 60 + seconds;
                            return totalSeconds; // Return total seconds
                        }
                    }
                }
                return null;
            }
            return null; // Return null if the timer element is not found
        }

        // Wait for the timer content to be updated
        function waitForTimerContent(callback) {
            const interval = setInterval(() => {
                const remainingTime = getRemainingTime();
                if (remainingTime !== null) {
                    clearInterval(interval); // Stop checking once we have valid time
                    callback(remainingTime);
                }
            }, 100); // Check every 100ms
        }

        // Receives information from backend
        function liveRecv(data) {
            const showContribution = (points) => {
                const beforeContribution = document.getElementById("beforeContribution");
                const afterContribution = document.getElementById("afterContribution");
                beforeContribution.style.display = "none";
                afterContribution.style.display = "block";
                afterContribution.innerHTML = `<p>Has contribuido con ${points} puntos al proyecto común.</p>`;
            };

            if (data.contributionPointsValid === true) {
                let confirmSend = confirm(`¿Estás seguro(a) que quieres contribuir con ${data.contributionPoints} puntos en el proyecto común?`);
                
                if (confirmSend) {
                    showContribution(data.contributionPoints);
                }
                return;
            } else if (data.contributionPointsValid === false) {
                alert(data.error);
            }
            

            // Helper function to get related DOM elements by `otherId`
            function getElements(otherId) {
                return {
                    offerButton: document.getElementById(ID_PREFIXES.offerButton + otherId),
                    offerInput: document.getElementById(ID_PREFIXES.offerInput + otherId),
                    requestButton: document.getElementById(ID_PREFIXES.requestButton + otherId),
                    requestInput: document.getElementById(ID_PREFIXES.requestInput + otherId),
                    afterAction: document.getElementById(ID_PREFIXES.afterAction + otherId),
                };
            }

            // Helper function to disable/enable inputs and buttons
            function toggleInputs(elements, disabled) {
                elements.offerButton.disabled = disabled;
                elements.offerInput.disabled = disabled;
                elements.requestButton.disabled = disabled;
                elements.requestInput.disabled = disabled;
            }

            // Helper function to update `afterAction` content
            function updateAfterAction(elements, display, content = '') {
                elements.afterAction.style.display = display ? 'block' : 'none';
                elements.afterAction.innerHTML = content;
            }

            // Handle offer points
            if (data.offerPoints) {
                const elements = getElements(data.otherId);
                toggleInputs(elements, true);

                if (data.initiator) {
                    elements.offerInput.value = "";
                    elements.requestInput.value = "";
                    updateAfterAction(
                        elements,
                        true,
                        `
                        <p class="text-center" style="font-weight: bold;">Ofreciste ${data.offerValue} puntos. Esperando respuesta.</p>
                        <div class="col-12 d-flex justify-content-center">
                            <button type="button" class="btn btn-secondary" onclick="closingTransaction('Cancelado', ${data.myId}, ${data.otherId}, ${data.transactionId})" style="width: auto;">Cancelar</button>
                        </div>
                        `
                    );
                }

                if (data.receiver) {
                    updateAfterAction(
                        elements,
                        true,
                        `
                        <p class="text-center" style="font-weight: bold;">Te ofrecieron ${data.offerValue} puntos. ¿Aceptas?</p>
                        <div class="col-12 d-flex justify-content-center" style="gap: 5px;">
                            <button type="button" class="btn btn-secondary" onclick="closingTransaction('Aceptado', ${data.myId}, ${data.otherId}, ${data.transactionId})" style="width: auto;">Aceptar</button>
                            <button type="button" class="btn btn-secondary" onclick="closingTransaction('Rechazado', ${data.myId}, ${data.otherId}, ${data.transactionId})" style="width: auto;">Rechazar</button>
                        </div>
                        `
                    );
                }
            }

            // Handle invalid offer points
            if (data.offerPoints === false) {
                alert(data.error);
                return;
            }

            // Handle request points
            if (data.requestPoints) {
                const elements = getElements(data.otherId);
                toggleInputs(elements, true);

                if (data.initiator) {
                    elements.offerInput.value = "";
                    elements.requestInput.value = "";
                    updateAfterAction(
                        elements,
                        true,
                        `
                        <p class="text-center" style="font-weight: bold;">Solicitaste ${data.requestValue} puntos. Esperando respuesta.</p>
                        <div class="col-12 d-flex justify-content-center">
                            <button type="button" class="btn btn-secondary" onclick="closingTransaction('Cancelado', ${data.myId}, ${data.otherId}, ${data.transactionId})" style="width: auto;">Cancelar</button>
                        </div>
                        `
                    );
                }

                if (data.receiver) {
                    console.log("receiver");
                    updateAfterAction(
                        elements,
                        true,
                        `
                        <p class="text-center" style="font-weight: bold;">Te solicitaron ${data.requestValue} puntos. ¿Aceptas?</p>
                        <div class="col-12 d-flex justify-content-center" style="gap: 5px;">
                            <button type="button" class="btn btn-secondary" onclick="closingTransaction('Aceptado', ${data.myId}, ${data.otherId}, ${data.transactionId})" style="width: auto;">Aceptar</button>
                            <button type="button" class="btn btn-secondary" onclick="closingTransaction('Rechazado', ${data.myId}, ${data.otherId}, ${data.transactionId})" style="width: auto;">Rechazar</button>
                        </div>
                        `
                    );
                }
            }

            // Handle invalid request points
            if (data.requestPoints === false) {
                const message = data.initiator
                    ? "No puedes solicitar más puntos de los que hay en tu grupo."
                    : "No puedes aceptar el monto solicitado dado que excede el total de puntos que tienes.";
                alert(message);
                return;
            }

            // Handle cancel action
            if (data.cancelAction) {
                const elements = getElements(data.otherId);
                toggleInputs(elements, false);
                updateAfterAction(elements, false);
            }

            if (data.update) {
                console.log("Before checking updateTransactions:");
                console.log("data.contributionPointsReload:", data.contributionPointsReload);
                console.log("data.updateTransactions:", data.updateTransactions);

                if (data.contributionPointsReload) {
                    console.log("update contribution")
                    showContribution(data.contributionPoints);
                }

                if (data.updateTransactions) {
                    if (data.reload === false) {
                        console.log("able buttons transactions");
                        let offerButton = document.getElementById('id_offerButton_' + data.otherId);
                        let offerInput = document.getElementById('id_offerInput_' + data.otherId);
                        let requestButton = document.getElementById('id_requestButton_' + data.otherId);
                        let requestInput = document.getElementById('id_requestInput_' + data.otherId);
                        let afterAction = document.getElementById('id_afterAction_' + data.otherId);

                        offerButton.disabled = false;
                        offerInput.disabled = false;
                        requestButton.disabled = false;
                        requestInput.disabled = false;
                        afterAction.style.display = "none";
                    }

                    const transactions = data.transactions;
                    const tableBody = document.getElementById('transactionsBody');
                    const tableContainer = document.getElementById('transactionsContainer');

                    console.log(transactions);

                    tableBody.innerHTML = '';

                    // Map the transactions to rows and append them
                    transactions.forEach((transaction, index) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${transaction["Jugador"]}</td>
                            <td>${transaction["Acción"]}</td>
                            <td>${transaction["A"]}</td>
                            <td>${transaction["Puntos"]}</td>
                            <td>${transaction["¿Se aceptó?"]}</td>
                            <td>${transaction["Balance"]}</td>
                        `;

                        tableBody.appendChild(row);

                        // If this is the last transaction, apply the highlight effect
                        if (index === transactions.length - 1) {
                            row.classList.add("new-transaction");
                            setTimeout(() => {
                                row.classList.remove("new-transaction");
                            }, 2000);
                        }
                    });

                    // Auto-scroll to the bottom smoothly
                    tableContainer.scrollTop = tableContainer.scrollHeight;

                    // Update the span with the last transaction's total
                    if (transactions.length > 0) {
                        const lastTransaction = transactions[transactions.length - 1]; // Get the last transaction
                        const pointsValueSpan = document.getElementById('points-value'); // Select the span
                        if (pointsValueSpan) {
                            pointsValueSpan.textContent = lastTransaction["Balance"]; // Update the span with the balance
                        }
                    }
                }
            }
        }

        // Execute the live method each time the page is reloaded
        document.addEventListener("DOMContentLoaded", function (event) {
            liveSend({'type': 'reloadPage'});

            // If session configs the sequential decision is True
            if (js_vars.secuential_decision) {
                waitForTimerContent((remainingTime) => {
                    const fifteenSecondsThreshold = 75; // 1 min 15 sec
                    const oneMinuteThreshold = 60; // 1 min
                    const isCitizen = js_vars.player_role !== "Funcionario"; // Check if the player is not the officer

                    // Function to display Bootstrap alerts (Each participant only sees their own)
                    function showAlert(message, alertType) {
                        let alertDiv = document.createElement("div");
                        alertDiv.className = `alert ${alertType} text-center`;
                        alertDiv.role = "alert";
                        alertDiv.textContent = message;

                        document.body.prepend(alertDiv); // Adds alert at the top of the page

                        // Remove the alert after 5 seconds
                        setTimeout(() => {
                            alertDiv.remove();
                        }, 5000);
                    }

                    // Show warning message at 1:15 only for this participant
                    if (remainingTime > fifteenSecondsThreshold) {
                        const timeToStartCountdown = remainingTime - fifteenSecondsThreshold;
                        setTimeout(() => {
                            showAlert(`Tienes 15 segundos restantes para interactuar con los demás participantes.`, "alert-warning");
                        }, timeToStartCountdown * 1000);
                    }

                    // Show info alert at 1:00 only for citizens (not for the officer)
                    if (remainingTime > oneMinuteThreshold && isCitizen) {
                        const timeToOneMinuteAlert = remainingTime - oneMinuteThreshold;
                        setTimeout(() => {
                            showAlert('Ahora decide cuánto contribuir al proyecto común.', "alert-info");
                        }, timeToOneMinuteAlert * 1000);
                    }

                    // Existing logic for enabling/disabling elements at 1 minute
                    if (remainingTime > oneMinuteThreshold) {
                        const timeToTrigger = remainingTime - oneMinuteThreshold;
                        setTimeout(() => {
                            enableLeftDisableRight();
                            console.log("enableLeftDisableRight called with 1 minute remaining.");
                        }, timeToTrigger * 1000);
                    } else {
                        enableLeftDisableRight(); // If less than 1 minute remains, trigger immediately
                        console.log("Immediate trigger: Less than 1 minute remaining.");
                    }
                });
            }

            if (js_vars.officer_interactions_public) {
                // Collect additional chat IDs directly from the template
                let additionalChatIds = [
                    {% for extra_chat in additional_channels %}
                        "{{ extra_chat.channel }}",
                    {% endfor %}
                ];

                document.querySelectorAll(".otree-chat").forEach(chat => {
                    let chatId = chat.id.split("-").pop(); // Extract last part of chat ID

                    if (additionalChatIds.includes(chatId)) {
                        console.log(`Hiding input and button for chat with ID: ${chatId}`);

                        // Hide input field
                        let inputField = chat.querySelector(".otree-chat__input");
                        if (inputField) {
                            inputField.style.display = "none"; // Completely hides the input
                        }

                        // Hide send button
                        let sendButton = chat.querySelector(".otree-chat__btn-send");
                        if (sendButton) {
                            sendButton.style.display = "none"; // Completely hides the button
                        }
                    }
                });
            }
        });
    </script>

{{ endblock }}